{% extends 'facilities/layout.html' %}
{% load crispy_forms_tags %}

{% block content %}
    <section class="mx-5">

        {% if facility_edits %}
            <div class="alert_message alert alert-warning alert-danger" role="alert" id="message_alert">
                <i class="fa-solid fa-circle-info"></i>
                This Facility's data has been updated. Approve or discard those changes before attempting to update.
                Navigate to <a href="/facilities/approve_changes/{{facility_edits.id}}">Approve this facility's edits</a>
            </div>
        {% endif %}

        <legend class="text-center"><b>{{ title }}</b></legend>
        <p class="mb-3 text-center"> {{sub_title}}</p>

        <form id="facility_form" action="" method="post" class="form-control mx-auto">
            {% csrf_token %}

            <h6 id="facility_toggle" class="green_text_color">Facility Information</h6>
            <div class="row  mb-5 form_section shadow-sm bg-white rounded p-3">

                  <div class="form-group col-md-3 mb-4">
                      <div class="d-flex">
                          {{ form.mfl_code|as_crispy_field }} <i class="fa-solid fa-magnifying-glass search_icon" id="search_icon"></i>
                      </div>

                      <p id="mfl_code_error" style="color:red"></p>
                  </div>
                  <div class="form-group col-md-5 mb-4">
                    {{ form.name|as_crispy_field }}
                  </div>
                    <div class="form-group col-md-4 mb-4">
                    {{ form.owner|as_crispy_field }}
                  </div>

                  <div class="form-group col-md-3 mb-3">
                        {{ form.county|as_crispy_field }}
                    </div>
                    <div class="form-group col-md-3 mb-3">
                        {{ form.sub_county|as_crispy_field }}
                    </div>
                    <div class="form-group col-md-3 mb-2">
                        {{ form.lat|as_crispy_field }}
                    </div>
                    <div class="form-group col-md-3 mb-2">
                        {{ form.lon|as_crispy_field }}
                    </div>

                    <div class="form-group col-md-6 mb-5">
                        {{ form.agency|as_crispy_field }}
                    </div>
                    <div class="form-group col-md-6 mb-5">
                        {{ form.partner|as_crispy_field }}
                    </div>

                    <div class="form-group col-md-4 mb-4">
                        <b>Implementation</b>
                        <div class="d-flex justify-content-between">
                            {{ form.CT|as_crispy_field }}
                            {{ form.HTS|as_crispy_field }}
                            {{ form.IL|as_crispy_field }}
                        </div>
                    </div>

            </div>

            <div class="hide_element" id="EMR_info">
                 <h6  class="green_text_color">EMR Information</h6>
                <div id="EMR" class="row  mb-5 form_section shadow-sm bg-white rounded p-4" >

<!--                        <b>EMR Information</b>-->
                        <div class="form-group col-md-6 mb-4">
                            {{ form.emr_type|as_crispy_field }}
                        </div>
                        <div class="form-group col-md-6 mb-4">
                            {{ form.emr_status|as_crispy_field }}
                        </div>

                        <div class="form-group col-md-10 mb-0">
                            <b>EMR modules</b>
                            <div class="d-flex justify-content-between">
                                {{ form.ovc_offered|as_crispy_field }}
                                {{ form.otz_offered|as_crispy_field }}
                                {{ form.prep_offered|as_crispy_field }}
                                {{ form.tb_offered|as_crispy_field }}
                                {{ form.mnch_offered|as_crispy_field }}
                                {{ form.kp_offered|as_crispy_field }}
                                {{ form.lab_man_offered|as_crispy_field }}
                            </div>
                        </div>
                </div>
            </div>

            <div id="MHealth_info">
                <h6 id="MHealth_toggle" class="green_text_color">MHealth Information</h6>
                <div class="row mb-5 form_section shadow-sm bg-white rounded p-4">
                    <div  class="row section mb-4 col-md-10">
                        <b>MHealth Information</b>
                        <div class="d-flex justify-content-between">
                            {{ form.mhealth_ushauri|as_crispy_field }}
                            {{ form.mhealth_nishauri|as_crispy_field }}
                            {{ form.mhealth_c4c|as_crispy_field }}
                            {{ form.mhealth_mlab|as_crispy_field }}
                            {{ form.mhealth_art|as_crispy_field }}
                            {{ form.mhealth_psurvey|as_crispy_field }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="hide_element" id="HTS_info">
                <h6  class="green_text_color">HTS Information</h6></br>
                <div id="HTS" class="row  mb-5 form_section shadow-sm bg-white rounded p-4">

                        <b>HTS Information</b>
                        <div class="form-group col-md-4 mb-0">
                            {{ form.hts_use|as_crispy_field }}
                        </div>
                        <div class="form-group col-md-4 mb-0">
                            {{ form.hts_deployment|as_crispy_field }}
                        </div>
                        <div class="form-group col-md-4 mb-0">
                            {{ form.hts_status|as_crispy_field }}
                        </div>

                </div>
            </div>

            <div class="hide_element" id="IL_info">
                <h6  class="green_text_color">Interoperability(IL) and Integration</h6>

                    <div id="IL" class="row section mb-5 form_section shadow-sm bg-white rounded p-4">
                        <b>IL Information</b>
                        <div class="form-group col-md-3 mb-0">
                            {{ form.webADT_registration|as_crispy_field }}
                        </div>
                        <div class="form-group col-md-3 mb-0">
                            {{ form.webADT_pharmacy|as_crispy_field }}
                        </div>
                        <div class="form-group col-md-6 mb-0">
                            {{ form.il_status|as_crispy_field }}
                        </div>
                        <div class="form-group col-md-5 mb-0">
                            <b>IL Modules</b>
                            <div class="d-flex justify-content-between">
                                {{ form.il_mlab|as_crispy_field }}
                                {{ form.il_three_PM|as_crispy_field }}
                                {{ form.il_air|as_crispy_field }}
                                {{ form.il_ushauri|as_crispy_field }}
                            </div>
                        </div>
                    </div>

            </div>

             {% if "/facilities/approve_changes/" in request.path %}
                <div class=" d-flex justify-content-around">
                    <div ><!-- onclick="//confirm_approval()" onclick="//confirm_rejection()"-->
                        <button name="approve" type="button" value="Approve changes" id="approve_changes" class="btn btn-success px-5" onclick="confirm_approval()">
                            <i class="fa-solid fa-thumbs-up"></i> Approve changes
                        </button>

                        <button name="discard" type="button" value="Discard changes" id="discard_changes" class="btn btn-danger px-5"  onclick="confirm_rejection()">
                            <i class="fa-solid fa-trash-can"></i> Discard changes
                        </button>
                    </div>
                </div>
            {% else %}
                 <div class="d-flex justify-content-center">
                     <input type="submit" value="Submit" class="btn green_bg_color text-white" style="width:200px;">
                 </div>

            {% endif %}

        </form>
    </section>

<script>

</script>



    <script>
        $(document).ready(function() {
          $(window).keydown(function(event){
            if(event.keyCode == 13) {
              event.preventDefault();
              return false;
            }
          });
        });


        //$(document).on("keypress", "#id_mfl_code", function(e){
        //if(e.which == 13){}
        //    });

        $("#search_icon").click(function() {

            var code_entered = $('#id_mfl_code').val();
            var base_url = window.location.origin;
            console.log(code_entered)
            $.post(base_url + '/facilities/get_mfl_data', {"code": code_entered}, function (data) {
                //localStorage.setItem('sdp_agencies', JSON.stringify(data)); //store a key/value
                console.log(data);
                if ('status' in data){
                    $("#mfl_code_error").html('That Facility was already added');
                    $("#id_name").val().prop("disabled",true);
                    $("#id_owner").val().prop("disabled",true);
                    $("#id_county").val().prop("disabled",true);
                    $("#id_sub_county").empty().prop("disabled",true);
                    $("#id_lat").val().prop("disabled",true);
                    $("#id_lon").val().prop("disabled",true);
                    $("#id_partner").val().prop("disabled",true);
                    $("#id_agency").val().prop("disabled",true);
                }else{
                    $("#id_mfl_code").val(data['mfl_code']).prop("disabled",false)
                    $("#id_name").val(data['name']).prop("disabled",false)
                    $("#id_owner").val(data['owner']).prop("disabled",false)
                    $("#id_county").val(data['county']).trigger("change").prop("disabled",false);
                    $("#id_sub_county").val(data['sub_county']).prop("disabled",false)
                    $("#id_lat").val(data['lat']).prop("disabled",false);
                    $("#id_lon").val(data['lon']).prop("disabled",false);
                    $("#id_partner").val(data['partner']).prop("disabled",false);
                    $("#id_agency").val(data['agency']).prop("disabled",false);
                }
            }).fail(function () {
                $("#mfl_code_error").html('Facility not available in KHMFL');
                $("#id_name").val()
                $("#id_owner").val()
                $("#id_county").val();
                $("#id_sub_county").empty();
                $("#id_lat").val();
                $("#id_lon").val();
                $("#id_partner").val();
                $("#id_agency").val();
            });
        });


        function confirm_approval(){
            Swal.fire({
              title: "Approve Changes?",
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#1ab394',
              cancelButtonColor: '#d33',
              confirmButtonText: 'Approve'
            }).then((result) => {
              if (result.isConfirmed) {
                Swal.fire(
                  'Success!',
                  'Changes were approved and now reflect.',
                  'success'
                )
                  $.get( "/send_customized_email", { "facility_id": "{{facilitydata.facility_info.id}}", "choice":"approved","reason":""});
                  $("#approve_changes").attr('type', 'submit');
                  setTimeout(function() {
                    $('#approve_changes').click();
                 }, 2000);

              }
            })

        }
    </script>

    <script>

        function confirm_rejection(){

            Swal.fire({
                title: "Reject Changes?",
                text:  "Reasons for Rejection? This will be sent to the modifier of this Facility for their knowledge",
                input: 'textarea',
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: 'Reject',
                confirmButtonColor: '#dc3545',
                preConfirm: (reasons) => {
                    $.get( "/send_customized_email", { "facility_id": "{{facilitydata.facility_info.id}}", "choice":"rejected","reason":reasons});
              }
            }).then((result) => {
              if (result.isConfirmed) {
                  Swal.fire(
                  'Success!',
                  'Success! Changes have been discarded!',
                  'success'
                );
                    $("#discard_changes").attr('type', 'submit');
                    setTimeout(function() {
                        Swal.close()
                        $('#discard_changes').click();
                     }, 2000);
              } else {
                    swal("Operation canceled!");
              }
            });
        }
    </script>

    <script type="text/javascript">
        const subcounty_id_saved = {{facilitydata.sub_county_id}};

        let disable_fields = false;
        {% if facility_edits %}
            if(window.location.href.indexOf("/facilities/update_facility/") > -1){
                disable_fields = true;
            }else{
                disable_fields = false;
            }
        {% endif %}
       // console.log(disable_fields)
    </script>

    {% load static %}
    <script src="{% static 'js/facilities_form.js' %}"></script>

{% endblock %}